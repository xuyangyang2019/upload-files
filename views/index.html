<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>file upload</title>
    <!-- 引入样式 -->
    <!-- <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css"> -->
    <link rel="stylesheet" href="/css/element-ui.css">
    <!-- 引入组件库 -->
    <!-- <script src="https://cdn.staticfile.org/vue/2.4.2/vue.min.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script> -->
    <script src="/js/vue.js"></script>
    <script src="/js/element.js"></script>
    <script src="/js/axios.js"></script>

    <style>
        #app {
            height: 100vh;
            width: 100vw;
            padding: 10px;
            overflow: hidden;
            box-sizing: border-box;

            display: flex;
            flex-direction: column;
        }

        /* .avatar-uploader .el-upload {
            border: 1px dashed #d9d9d9;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        } */
    </style>
</head>

<body style="margin: 0; overflow: hidden;">
    <div id="app">

        <el-row type="flex" align="middle" justify="center">
            <h1>Welcome to file uplaod</h1>
        </el-row>
        <el-row style="margin-bottom:10px;" type="flex" align="middle" justify="start">
            <a href="/files">
                <i class="el-icon-setting"></i>
                <span slot="title">文件目录</span>
            </a>
        </el-row>

        <el-tabs :tab-position="'left'" style=" flex: 1 1 auto; ">
            <el-tab-pane label="文件上传">
                <el-upload class="upload-demo" drag action="/api/upload" multiple :show-file-list="true"
                    :on-success="handleAvatarSuccess" :before-upload="beforeAvatarUpload">
                    <i class="el-icon-upload"></i>
                    <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
                    <!-- <div class="el-upload__tip" slot="tip">只能上传jpg/png文件，且不超过500kb</div> -->
                    <div class="el-upload__tip" slot="tip">文件大小不能超过10M</div>
                </el-upload>
                <div>
                    <p>返回结果</p>
                    {{result}}
                </div>

                <!-- <form method="POST" action="/file/upload" enctype="multipart/form-data">
                    <p>file upload</p>
                    <span>picName:</span><input name="picName" type="text" /><br />
                    <input name="file" type="file" /><br /><br />
                    <button type="submit">submit</button>
                </form> -->
            </el-tab-pane>

            <el-tab-pane label="文件上传异步">
                <el-button class="btn" id="J_UploadPictureBtn" @click="uploadImg">上传图片</el-button>

                <hr />
                <p>上传进度<span id="J_UploadProgress">0</span>%</p>
                <p>上传结果图片</p>
                <div id="J_PicturePreview" class="preview-picture">
                </div>
            </el-tab-pane>

            <el-tab-pane label="文件管理">
                <el-row type="flex" aling="middle">
                    文件名
                    文件类型
                    时间

                    <el-button type="primary" @click="getUploadFiles">查询文件</el-button>
                </el-row>

                <el-table :data="filesList" style="width: 100%" height="70vh">
                    <el-table-column type="index" label="-" width="50"></el-table-column>
                    <el-table-column prop="filename" label="文件名"></el-table-column>
                    <el-table-column prop="mimeType" label="文件类型"></el-table-column>
                    <el-table-column prop="url" label="地址">
                        <template slot-scope="{row}">
                            <div>
                                <p v-text="row.url"></p>
                                <img v-if="row.mimeType === 'image/jpeg'" style="height:100px;width: auto;"
                                    :src="row.url" />
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column prop="createdAt" label="上传日期" width="180">
                        <template slot-scope="{row}">
                            {{ new Date(row.createdAt).toLocaleString() }}
                        </template>
                    </el-table-column>
                    <el-table-column prop="success" label="结果" width="100">
                        <template slot-scope="{row}">
                            <el-tag v-if="row.success" type="success">成功</el-tag>
                            <div v-else v-text="row.message">
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column label="操作">
                        <template slot-scope="scope">
                            <el-button size="mini" type="danger">删除</el-button>
                            <el-button size="mini" type="primary">下载</el-button>
                        </template>
                    </el-table-column>
                </el-table>

                <el-pagination style="margin: 20px auto; " @size-change="handleSizeChange"
                    @current-change="handleCurrentChange" :current-page="currentPage" :page-sizes="[10, 20, 30, 40]"
                    :page-size="pageSize" layout="total, sizes, prev, pager, next, jumper" :total="total">
                </el-pagination>
            </el-tab-pane>
        </el-tabs>
    </div>

    <script>
        const UtilType = {
            isPrototype: function (data) {
                return Object.prototype.toString.call(data).toLowerCase()
            },
            isJSON: function (data) {
                return this.isPrototype(data) === '[object object]'
            },
            isFunction: function (data) {
                return this.isPrototype(data) === '[object function]'
            }
        }

        new Vue({
            el: '#app',
            data: function () {
                return {
                    activeIndex: '/',
                    imageUrl: '',
                    result: {},

                    filesList: [],
                    total: 0,
                    currentPage: 1,
                    pageSize: 10,

                    visible: false,
                    num: 0,

                }
            },
            created() {
                // this.fun()
            },
            methods: {
                // 获取文件列表
                getUploadFiles() {
                    let baseurl_ = 'http://localhost:3001'
                    // let baseurl_ = 'http://xyy.life:3001'
                    var params = {
                        page: this.currentPage,
                        limit: this.pageSize,
                    };
                    axios.get(`${baseurl_}/api/file`, { params: params })
                        .then(res => {
                            if (res?.data && res.data.code === 20000) {
                                console.log(res.data)
                                this.filesList = res.data.data?.list || []
                                this.total = res.data.data?.total || 0
                            }

                        })
                        .catch(error => {
                            console.log(error)
                        })
                },
                handleSizeChange(val) {
                    this.pageSize = val
                    this.getUploadFiles()
                },
                handleCurrentChange(val) {
                    this.currentPage = val
                    this.getUploadFiles()
                },

                // 上传成功回调函数
                handleAvatarSuccess(res, file) {
                    this.result = res
                    this.imageUrl = URL.createObjectURL(file.raw);
                },
                // 上传之前做些什么
                beforeAvatarUpload(file) {
                    // const isJPG = file.type === 'image/jpeg';
                    const isLt2M = file.size / 1024 / 1024 < 10;

                    // if (!isJPG) {
                    //     this.$message.error('上传头像图片只能是 JPG 格式!');
                    // }
                    if (!isLt2M) {
                        this.$message.error('文件大小不能超过 10MB!');
                    }
                    // return isJPG && isLt2M;
                    return isLt2M;
                },

                // 上传文件
                requestEvent(options) {
                    try {
                        let formData = options.formData
                        let xhr = new XMLHttpRequest()
                        xhr.onreadystatechange = function () {
                            if (xhr.readyState === 4 && xhr.status === 200) {
                                options.success(JSON.parse(xhr.responseText))
                            }
                        }

                        xhr.upload.onprogress = function (evt) {
                            let loaded = evt.loaded
                            let tot = evt.total
                            let per = Math.floor((100 * loaded) / tot)
                            options.progress(per)
                        }
                        xhr.open('post', '/api/upload')
                        xhr.send(formData)
                    } catch (err) {
                        options.fail(err)
                    }
                },
                // 选择文件
                uploadEvent(options) {
                    let file
                    let formData = new FormData()
                    let input = document.createElement('input')
                    input.setAttribute('type', 'file')
                    input.setAttribute('name', 'files')

                    input.click()
                    input.onchange = () => {
                        file = input.files[0]
                        formData.append('files', file)

                        this.requestEvent({
                            formData,
                            success: options.success,
                            fail: options.fail,
                            progress: options.progress,
                        })
                    }
                },
                // 上传的回调函数判断
                uploadAction(options) {
                    if (!UtilType.isJSON(options)) {
                        console.log('upload options is null')
                        return
                    }
                    let _options = {}
                    _options.success = UtilType.isFunction(options.success)
                        ? options.success
                        : function () { }
                    _options.fail = UtilType.isFunction(options.fail)
                        ? options.fail
                        : function () { }
                    _options.progress = UtilType.isFunction(options.progress)
                        ? options.progress
                        : function () { }

                    this.uploadEvent(_options)
                },
                // 点击事件
                uploadImg() {
                    // let btn = document.getElementById('J_UploadPictureBtn')
                    let progressElem = document.getElementById('J_UploadProgress')
                    let previewElem = document.getElementById('J_PicturePreview')
                    this.uploadAction({
                        success: function (result) {
                            if (result && result.code === 20000 && result.data) {
                                previewElem.innerHTML =
                                    '<img src="' + result.data.url + '" style="max-width: 100%">'
                            }
                        },
                        progress: function (data) {
                            if (data && data * 1 > 0) {
                                progressElem.innerText = data
                            }
                        },
                    })
                }

                // fun() {
                //     if (this.num >= 100) return
                //     setTimeout(() => {
                //         this.num += 20
                //         this.fun()
                //     }, 1000)
                // }
            },
        })
    </script>
</body>

</html>